<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Training Log</title>
  <style>
    :root{
      --bg:#f2f2f7;
      --card-bg:#ffffff;
      --primary:#1c1c1e;
      --secondary:#8e8e93;
      --accent:#007aff;
      --border:#d1d1d6;
      --highlight:#e5f1ff;
      --rest-bg:#5856d6;
      --progress-bg:#34c759;
    }

    body{
      font-family:-apple-system, system-ui, sans-serif;
      background-color:var(--bg);
      color:var(--primary);
      margin:0;
      padding:10px;
      font-size:14px;
    }

    header{ text-align:center; margin-bottom:10px; }
    h1{ font-size:1.1rem; text-transform:uppercase; margin:0; }

    .date-selector{
      background:#fff;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--border);
      margin-bottom:10px;
      text-align:center;
    }
    .date-selector label{
      font-size:0.7rem;
      font-weight:800;
      display:block;
      margin-bottom:4px;
      color:var(--secondary);
    }
    .date-selector input{
      font-size:16px;
      padding:8px;
      border-radius:8px;
      border:1px solid var(--border);
      width:100%;
      box-sizing:border-box;
    }

    .rpe-bar{
      background:var(--primary);
      color:white;
      padding:10px;
      border-radius:10px;
      font-size:0.7rem;
      margin-bottom:12px;
      display:flex;
      justify-content:space-around;
      font-weight:600;
    }
    .rpe-bar span b{ color:var(--accent); }

    .coach-box{
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      margin-bottom:12px;
    }
    .coach-box label{
      display:block;
      font-size:0.7rem;
      font-weight:800;
      color:var(--secondary);
      margin-bottom:6px;
      text-transform:uppercase;
    }
    .coach-box textarea{
      width:100%;
      height:110px;
      border-radius:10px;
      border:2px solid var(--border);
      padding:10px;
      box-sizing:border-box;
      font-size:14px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background:#fff;
    }
    .coach-actions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }

    details{
      background:var(--card-bg);
      border-radius:12px;
      margin-bottom:10px;
      border:1px solid var(--border);
      overflow:hidden;
    }
    summary{
      padding:16px;
      font-weight:700;
      text-transform:uppercase;
      list-style:none;
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
    }
    summary::after{ content:'＋'; color:var(--accent); }
    details[open] summary::after{ content:'－'; }

    .content{
      padding:0 12px 12px 12px;
      border-top:1px solid #f2f2f7;
    }
    .sub-section{
      margin-top:10px;
      padding:10px;
      background:#fafafa;
      border-radius:8px;
      border:1px solid #eee;
    }
    .sub-title{
      font-weight:bold;
      font-size:0.75rem;
      color:var(--secondary);
      text-transform:uppercase;
      display:block;
      margin-bottom:6px;
    }
    .treadmill-setting{
      display:flex;
      justify-content:space-between;
      background:var(--highlight);
      padding:8px;
      border-radius:6px;
      margin-bottom:4px;
      font-weight:700;
      border-left:3px solid var(--accent);
    }

    .superset-container{
      border-left:4px solid var(--accent);
      background:#fff;
      margin:12px 0;
      padding:12px;
      border-radius:0 8px 8px 0;
      border:1px solid #e5e5ea;
    }
    .superset-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }
    .rest-badge{
      background:var(--rest-bg);
      color:white;
      padding:2px 8px;
      border-radius:10px;
      font-size:10px;
      font-weight:bold;
    }
    .target-rpe-tag{
      color:var(--accent);
      font-weight:bold;
      font-size:0.7rem;
      text-transform:uppercase;
    }
    .exercise-label{
      font-weight:600;
      font-size:0.85rem;
      display:block;
      margin-top:8px;
      margin-bottom:4px;
    }
    .target-line{
      display:block;
      margin:6px 0 2px 0;
      font-size:0.75rem;
      color:var(--secondary);
    }
    .target-line b{ color:var(--accent); }

    .set-grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:6px;
      margin-bottom:8px;
    }
    .set-grid input{
      padding:10px;
      border:1px solid var(--border);
      border-radius:6px;
      text-align:center;
      font-size:14px;
      width:100%;
      box-sizing:border-box;
    }

    .feedback-row{
      display:grid;
      grid-template-columns: 1fr 1.5fr;
      gap:8px;
      align-items:center;
      margin-top:10px;
      border-top:1px solid #eee;
      padding-top:12px;
    }
    .rpe-select{
      padding:12px;
      border:1px solid var(--border);
      border-radius:8px;
      background:var(--highlight);
      color:var(--accent);
      font-weight:bold;
      font-size:15px;
      -webkit-appearance:none;
      appearance:none;
    }
    .notes-input{
      padding:12px;
      border:1px solid var(--border);
      border-radius:8px;
      font-style:italic;
      font-size:14px;
      background:#fff;
      box-sizing:border-box;
      width:100%;
    }

    .checkbox-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 0;
      border-bottom:1px solid #eee;
    }
    input[type="checkbox"]{ width:22px; height:22px; }

    .summary-box{
      width:100%;
      margin-top:15px;
      height:100px;
      padding:12px;
      border:2px solid var(--border);
      border-radius:12px;
      font-size:16px;
      background:#fff;
      box-sizing:border-box;
    }

    .actions{
      margin-top:20px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      padding-bottom:20px;
    }
    .btn{
      padding:16px;
      border-radius:12px;
      border:none;
      font-weight:bold;
      cursor:pointer;
      color:white;
    }
    .btn-share{ background:var(--accent); }
    .btn-clear{ background:var(--secondary); opacity:0.85; }
    .btn-apply{ background:var(--progress-bg); }

    .status-msg{
      text-align:center;
      color:var(--secondary);
      font-size:0.7rem;
      padding-bottom:20px;
    }
  
    .coach-badge{
      display:none;
      background: var(--progress-bg);
      color:white;
      padding:6px 10px;
      border-radius:999px;
      font-size:0.7rem;
      font-weight:800;
      text-align:center;
      margin-bottom:10px;
    }

  
    .coach-note{
      display:none;
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      margin-bottom:12px;
      font-size:0.9rem;
      line-height:1.25rem;
      white-space:pre-wrap;
    }
    .coach-note .title{
      display:block;
      font-size:0.7rem;
      font-weight:800;
      color:var(--secondary);
      margin-bottom:6px;
      text-transform:uppercase;
      letter-spacing:0.02em;
    }
    .coach-controls{
      display:none;
      margin-bottom:12px;
    }
    .hidden{ display:none !important; }

  
/* ===== Auth UI responsiveness ===== */
.auth-bar{
  display:grid;
  grid-template-columns: 1fr 1fr auto auto;
  gap:8px;
  align-items:center;
  margin-bottom:8px;
}
.auth-bar input, .auth-bar button{
  padding:12px;
  border-radius:10px;
  border:1px solid var(--border);
  font-size:16px;
}
.auth-links{
  display:flex;
  justify-content:center;
  gap:12px;
  margin:6px 0 12px;
  font-size:0.85rem;
}
.auth-links .btn{
  padding:10px 12px;
  border-radius:10px;
}
.auth-status{
  margin-bottom:12px;
  font-size:0.85rem;
  color:var(--secondary);
  text-align:center;
}
@media (max-width: 640px){
  .auth-bar{ grid-template-columns: 1fr; }
  .auth-bar input, .auth-bar button{ width:100%; }
  .auth-links{ flex-direction:column; gap:8px; }
  .auth-links button{ width:100%; }
}

</style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body onload="initApp()">
  <header><h1>Training Log</h1></header>


  <div id="authBar" class="auth-bar">
    <input id="email" type="email" placeholder="email">
    <input id="password" type="password" placeholder="password">
    <button id="loginBtn" type="button" class="btn btn-share">Login</button>
    <button id="logoutBtn" type="button" class="btn btn-clear">Logout</button>
  </div>
  <div id="authStatus" class="auth-status"></div>

  <div id="authLinks" class="auth-links">
    <button id="magicLinkBtn" type="button" class="btn btn-clear" style="padding:8px 10px; border-radius:10px;">Email me a magic link</button>
    <button id="forgotPwBtn" type="button" class="btn btn-clear" style="padding:8px 10px; border-radius:10px;">Forgot password</button>
  </div>


  <div id="recoveryBox" class="card" style="display:none; margin-bottom:12px;">
    <div style="font-weight:800; margin-bottom:6px;">Set a new password</div>
    <div style="font-size:0.9rem; color:var(--secondary); margin-bottom:10px;">
      You opened a password recovery link. Choose a new password below.
    </div>
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <input id="newPassword" type="password" placeholder="New password" style="flex:1; min-width:220px; padding:10px; border-radius:10px; border:1px solid var(--border);">
      <input id="newPassword2" type="password" placeholder="Confirm password" style="flex:1; min-width:220px; padding:10px; border-radius:10px; border:1px solid var(--border);">
      <button id="setPasswordBtn" type="button" class="btn btn-share" style="padding:12px; border-radius:10px;">Set Password</button>
    </div>
    <div id="recoveryStatus" style="margin-top:8px; font-size:0.85rem; color:var(--secondary);"></div>
  </div>


  <div class="date-selector">
    <label>LOG WEEK STARTING</label>
    <input type="date" id="weekDate" onchange="loadWeekData()">
  </div>

  <div class="rpe-bar">
    <span><b>6:</b> Aerobic</span>
    <span><b>7:</b> Steady/Tempo</span>
    <span><b>8:</b> Hard</span>
  </div>

  <div id="coachBadge" class="coach-badge">COACH TARGETS ACTIVE</div>

  <div id="coachNote" class="coach-note">
    <span class="title">COACH INSTRUCTIONS</span>
    <div id="coachNoteText"></div>
  </div>

  <div id="coachControls" class="coach-controls">
    <button type="button" class="btn btn-clear" onclick="clearTargets()">CLEAR COACH TARGETS</button>
  </div>



  <div class="coach-box" id="coachBox">
    <label>PASTE COACH TARGETS (KEY: VALUE)</label>
    <textarea id="Coach_Targets" placeholder="Example:
Mon_Main_Inc: 3% Inc
Tue_A2_Bench_Target: 145x10 x3
Thu_A1_Squat_Target: 125x6-8 x3"></textarea>
    <div class="coach-actions">
      <button type="button" class="btn btn-apply" onclick="applyCoachTargets()">APPLY TARGETS</button>
      <button type="button" class="btn btn-clear" onclick="clearTargets()">CLEAR TARGETS</button>
    </div>
  </div>

  <form id="trackerForm">

    <details>
      <summary>Mon: Interval Pyramid</summary>
      <div class="content">
        <span class="target-rpe-tag">Target RPE: <span data-target="Mon_TargetRPE">8</span></span>
        <div class="sub-section">
          <span class="sub-title">Warm-up (10m)</span>
          <div class="treadmill-setting"><span data-target="Mon_WU_Speed">6.3 MPH</span><span data-target="Mon_WU_Inc">1% Inc</span></div>
          <span class="sub-title" style="margin-top:10px;">Main (3-4-5-4-3m)</span>
          <div class="treadmill-setting"><span data-target="Mon_Main_Speed">7.4-7.6 MPH</span><span data-target="Mon_Main_Inc">2% Inc</span></div>
          <span style="font-size:0.7rem;color:#666;font-style:italic;">Rest: 90s walk between intervals.</span>
          <span class="sub-title" style="margin-top:10px;">Cool-down (5m)</span>
          <div class="treadmill-setting"><span data-target="Mon_CD_Speed">6.0 MPH</span><span data-target="Mon_CD_Inc">0% Inc</span></div>
        </div>
        <div class="feedback-row">
          <select id="Mon_RPE" class="rpe-select" data-name="Mon RPE">
            <option value="">Actual RPE</option><option>6</option><option>7</option><option>8</option><option>9</option>
          </select>
          <input type="text" id="Mon_Notes" class="notes-input" data-name="Mon Notes" placeholder="Session Notes...">
        </div>
      </div>
    </details>

    <details>
      <summary>Tue: Strength A (Upper)</summary>
      <div class="content">

        <div class="superset-container">
          <div class="superset-header">
            <span class="target-rpe-tag">RPE: <span data-target="Tue_RPE_A_Target">8</span></span>
            <span class="rest-badge">REST 90s</span>
          </div>
          <span class="exercise-label">A1: Pull-ups (<span data-target="Tue_A1_Pullups_Target">3x5-8</span>)</span>
<div class="set-grid">
            <input type="text" id="Tue_A1_S1" data-name="Pullups S1" placeholder="reps">
            <input type="text" id="Tue_A1_S2" data-name="Pullups S2" placeholder="reps">
            <input type="text" id="Tue_A1_S3" data-name="Pullups S3" placeholder="reps">
          </div>

          <span class="exercise-label">A2: Bench Press (<span data-target="Tue_A2_Bench_Target">3x8-12</span>)</span>
<div class="set-grid">
            <input type="text" id="Tue_A2_S1" data-name="Bench S1" placeholder="lb x rep">
            <input type="text" id="Tue_A2_S2" data-name="Bench S2" placeholder="lb x rep">
            <input type="text" id="Tue_A2_S3" data-name="Bench S3" placeholder="lb x rep">
          </div>

          <div class="feedback-row">
            <select id="Tue_RPE_A" class="rpe-select" data-name="Tue A RPE">
              <option value="">Actual RPE</option><option>6</option><option>7</option><option>8</option><option>9</option>
            </select>
            <input type="text" id="Tue_Notes_A" class="notes-input" data-name="Tue A Notes" placeholder="A Notes">
          </div>
        </div>

        <div class="superset-container">
          <div class="superset-header">
            <span class="target-rpe-tag">RPE: <span data-target="Tue_RPE_B_Target">7</span></span>
            <span class="rest-badge">REST 60s</span>
          </div>

          <span class="exercise-label">B1: 1-Arm Row (<span data-target="Tue_B1_Row_Target">3x8-10</span>)</span>
<div class="set-grid">
            <input type="text" id="Tue_B1_S1" data-name="Row S1" placeholder="lb x rep">
            <input type="text" id="Tue_B1_S2" data-name="Row S2" placeholder="lb x rep">
            <input type="text" id="Tue_B1_S3" data-name="Row S3" placeholder="lb x rep">
          </div>

          <span class="exercise-label">B2: Incline DB (<span data-target="Tue_B2_IncDB_Target">3x10-12</span>)</span>
<div class="set-grid">
            <input type="text" id="Tue_B2_S1" data-name="IncDB S1" placeholder="lb x rep">
            <input type="text" id="Tue_B2_S2" data-name="IncDB S2" placeholder="lb x rep">
            <input type="text" id="Tue_B2_S3" data-name="IncDB S3" placeholder="lb x rep">
          </div>

          <div class="feedback-row">
            <select id="Tue_RPE_B" class="rpe-select" data-name="Tue B RPE">
              <option value="">Actual RPE</option><option>6</option><option>7</option><option>8</option><option>9</option>
            </select>
            <input type="text" id="Tue_Notes_B" class="notes-input" data-name="Tue B Notes" placeholder="B Notes">
          </div>
        </div>

        <div class="superset-container">
          <div class="superset-header">
            <span class="target-rpe-tag">RPE: <span data-target="Tue_RPE_C_Target">7</span></span>
            <span class="rest-badge">REST 60s</span>
          </div>

          <span class="exercise-label">C1: Dips (<span data-target="Tue_C1_Dips_Target">3x6-10</span>)</span>
<div class="set-grid">
            <input type="text" id="Tue_C1_S1" data-name="Dips S1" placeholder="reps">
            <input type="text" id="Tue_C1_S2" data-name="Dips S2" placeholder="reps">
            <input type="text" id="Tue_C1_S3" data-name="Dips S3" placeholder="reps">
          </div>

          <span class="exercise-label">C2: Rear Delt Fly (<span data-target="Tue_C2_Fly_Target">3x12-15</span>)</span>
<div class="set-grid">
            <input type="text" id="Tue_C2_S1" data-name="Fly S1" placeholder="lb x rep">
            <input type="text" id="Tue_C2_S2" data-name="Fly S2" placeholder="lb x rep">
            <input type="text" id="Tue_C2_S3" data-name="Fly S3" placeholder="lb x rep">
          </div>

          <div class="feedback-row">
            <select id="Tue_RPE_C" class="rpe-select" data-name="Tue C RPE">
              <option value="">Actual RPE</option><option>6</option><option>7</option><option>8</option><option>9</option>
            </select>
            <input type="text" id="Tue_Notes_C" class="notes-input" data-name="Tue C Notes" placeholder="C Notes">
          </div>
        </div>
      </div>
    </details>

    <details>
      <summary>Wed: Hill Fartlek</summary>
      <div class="content">
        <span class="target-rpe-tag">Target RPE: <span data-target="Wed_TargetRPE">6</span></span>
        <div class="sub-section">
          <span class="sub-title">Warm-up (5m)</span>
          <div class="treadmill-setting"><span data-target="Wed_WU_Speed">6.3 MPH</span><span data-target="Wed_WU_Inc">1% Inc</span></div>
          <span class="sub-title" style="margin-top:10px;">Main (20m)</span>
          <div class="treadmill-setting"><span data-target="Wed_Main_Speed">6.5 MPH</span><span data-target="Wed_Main_Inc">4% Inc</span></div>
          <span style="font-size:0.7rem;color:#666;font-style:italic;">Spike to 4% for 60s every 3 mins.</span>
          <span class="sub-title" style="margin-top:10px;">Cool-down (3m)</span>
          <div class="treadmill-setting"><span data-target="Wed_CD_Speed">5.8 MPH</span><span data-target="Wed_CD_Inc">0% Inc</span></div>
        </div>
        <div class="feedback-row">
          <select id="Wed_RPE" class="rpe-select" data-name="Wed RPE">
            <option value="">Actual RPE</option><option>6</option><option>7</option><option>8</option><option>9</option>
          </select>
          <input type="text" id="Wed_Notes" class="notes-input" data-name="Wed Notes" placeholder="Notes...">
        </div>
      </div>
    </details>

    <details>
      <summary>Thu: Strength B (Lower)</summary>
      <div class="content">

        <div class="superset-container">
          <div class="superset-header">
            <span class="target-rpe-tag">RPE: <span data-target="Thu_RPE_A_Target">8</span></span>
            <span class="rest-badge">REST 90s</span>
          </div>

          <span class="exercise-label">A1: BB Squat (<span data-target="Thu_A1_Squat_Target">3x5-8</span>)</span>
<div class="set-grid">
            <input type="text" id="Thu_A1_S1" data-name="Squat S1" placeholder="lb x rep">
            <input type="text" id="Thu_A1_S2" data-name="Squat S2" placeholder="lb x rep">
            <input type="text" id="Thu_A1_S3" data-name="Squat S3" placeholder="lb x rep">
          </div>

          <span class="exercise-label">A2: Reverse Lunge (<span data-target="Thu_A2_Lunge_Target">3x8/leg</span>)</span>
<div class="set-grid">
            <input type="text" id="Thu_A2_S1" data-name="Lunge S1" placeholder="lb x rep">
            <input type="text" id="Thu_A2_S2" data-name="Lunge S2" placeholder="lb x rep">
            <input type="text" id="Thu_A2_S3" data-name="Lunge S3" placeholder="lb x rep">
          </div>

          <div class="feedback-row">
            <select id="Thu_RPE_A" class="rpe-select" data-name="Thu A RPE">
              <option value="">Actual RPE</option><option>6</option><option>7</option><option>8</option><option>9</option>
            </select>
            <input type="text" id="Thu_Notes_A" class="notes-input" data-name="Thu A Notes" placeholder="Notes">
          </div>
        </div>

        <div class="superset-container">
          <div class="superset-header">
            <span class="target-rpe-tag">RPE: <span data-target="Thu_RPE_B_Target">7</span></span>
            <span class="rest-badge">REST 90s</span>
          </div>

          <span class="exercise-label">B1: BB RDL (<span data-target="Thu_B1_RDL_Target">3x8-10</span>)</span>
<div class="set-grid">
            <input type="text" id="Thu_B1_S1" data-name="RDL S1" placeholder="lb x rep">
            <input type="text" id="Thu_B1_S2" data-name="RDL S2" placeholder="lb x rep">
            <input type="text" id="Thu_B1_S3" data-name="RDL S3" placeholder="lb x rep">
          </div>

          <span class="exercise-label">B2: Good Morning (<span data-target="Thu_B2_GM_Target">2x8-10</span>)</span>
<div class="set-grid">
            <input type="text" id="Thu_B2_S1" data-name="GM S1" placeholder="lb x rep">
            <input type="text" id="Thu_B2_S2" data-name="GM S2" placeholder="lb x rep">
          </div>

          <div class="feedback-row">
            <select id="Thu_RPE_B" class="rpe-select" data-name="Thu B RPE">
              <option value="">Actual RPE</option><option>6</option><option>7</option><option>8</option><option>9</option>
            </select>
            <input type="text" id="Thu_Notes_B" class="notes-input" data-name="Thu B Notes" placeholder="Notes">
          </div>
        </div>
      </div>
    </details>

    <details>
      <summary>Fri: Core & Stability</summary>
      <div class="content">
        <span class="target-rpe-tag">Target RPE: <span data-target="Fri_TargetRPE">6</span></span>
        <div class="checkbox-row"><span>Dead Bug (<span data-target="Fri_C1_DeadBug_Target">3x8/side</span>)</span>
<input type="checkbox" id="Fri_C1" data-name="DeadBug"></div>
        <div class="checkbox-row"><span>Side Plank (<span data-target="Fri_C2_SidePlank_Target">2x40s/side</span>)</span>
<input type="checkbox" id="Fri_C2" data-name="SidePlank"></div>
        <div class="checkbox-row"><span>Bird Dog (<span data-target="Fri_C3_BirdDog_Target">2x8/side</span>)</span>
<input type="checkbox" id="Fri_C3" data-name="BirdDog"></div>
        <div class="checkbox-row"><span>Suitcase Carry (<span data-target="Fri_C4_Carry_Target">2x45s/side</span>)</span>
<input type="checkbox" id="Fri_C4" data-name="Carry"></div>
        <div class="feedback-row">
          <select id="Fri_RPE" class="rpe-select" data-name="Fri RPE">
            <option value="">Actual RPE</option><option>6</option><option>7</option><option>8</option><option>9</option>
          </select>
          <input type="text" id="Fri_Notes" class="notes-input" data-name="Fri Notes" placeholder="Notes...">
        </div>
      </div>
    </details>

    <details>
      <summary>Sat: Long Run (Progression)</summary>
      <div class="content">
        <span class="target-rpe-tag">Target RPE: <span data-target="Sat_TargetRPE">7</span></span>
        <div class="sub-section">
          <span class="sub-title">Base (30m)</span>
          <div class="treadmill-setting"><span data-target="Sat_Base_Speed">6.6 MPH</span><span data-target="Sat_Base_Inc">1% Inc</span></div>
          <span class="sub-title" style="margin-top:10px;">Build (15m)</span>
          <div class="treadmill-setting"><span data-target="Sat_Build_Speed">6.7-7.2 MPH</span><span data-target="Sat_Build_Inc">2% Inc</span></div>
          <span style="font-size:0.7rem;color:#666;font-style:italic;">Build: +0.1 MPH every 3 mins.</span>
          <span class="sub-title" style="margin-top:10px;">Cool-down (5m)</span>
          <div class="treadmill-setting"><span>Walk</span><span>0% Inc</span></div>
        </div>
        <div class="feedback-row">
          <select id="Sat_RPE" class="rpe-select" data-name="Sat RPE">
            <option value="">Actual RPE</option><option>6</option><option>7</option><option>8</option><option>9</option>
          </select>
          <input type="text" id="Sat_Notes" class="notes-input" data-name="Sat Notes" placeholder="Endurance notes...">
        </div>
      </div>
    </details>

    <textarea id="Weekly_Commentary" class="summary-box" data-name="WEEKLY SUMMARY" placeholder="Overall review and recovery status..."></textarea>

    <div class="actions">
      <button type="button" class="btn btn-share" onclick="shareData()">COPY SUMMARY</button>
      <button type="button" class="btn btn-clear" onclick="clearWeek()">CLEAR WEEK</button>
    </div>
    <div id="status" class="status-msg">Ready.</div>
  </form>

  
  <script>
    // ===== Supabase (Auth + DB) =====
    const SUPABASE_URL = "https://hagffbmzsfrsxwuokppn.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_-w_qtI5zMzFJ3F41IO8Djw_59jyAJTr";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let saveTimer = null;
    let syncing = false;

    function setStatus(msg){
      document.getElementById('status').innerText = msg;
    }

    function getWeekStart(){
      return document.getElementById('weekDate').value;
    }

    function getStorageKey(dateStr){
      return 'training_log_v3_' + (dateStr || getWeekStart());
    }

    function getTargetsKey(dateStr){
      return 'training_targets_v1_' + (dateStr || getWeekStart());
    }

    async function refreshAuthUI(){
      const { data } = await supabaseClient.auth.getUser();
      currentUser = data?.user ?? null;

      document.getElementById('logoutBtn').style.display = currentUser ? 'inline-block' : 'none';
      document.getElementById('loginBtn').style.display = currentUser ? 'none' : 'inline-block';
      document.getElementById('email').style.display = currentUser ? 'none' : 'inline-block';
      document.getElementById('password').style.display = currentUser ? 'none' : 'inline-block';

      document.getElementById('authStatus').textContent = currentUser
        ? `Signed in as ${currentUser.email} (sync on)`
        : 'Not signed in (local-only).';

      document.getElementById('authLinks').style.display = currentUser ? 'none' : 'flex';
    
      
      // Hide recovery UI unless we're actively in a recovery session
      const recoveryActive = (sessionStorage.getItem('pw_recovery_pending') === '1');
      if (!recoveryActive){
        const rb = document.getElementById('recoveryBox');
        if (rb) rb.style.display = 'none';
      }
}

    async function login(){
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      if (!email || !password) return alert('Enter email + password');

      const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) return alert(error.message);

      sessionStorage.removeItem('pw_recovery_pending');
      await refreshAuthUI();
      await syncFromServerForWeek();
      setStatus('Logged in. Synced.');
    }
    
    async function sendMagicLink(){
      const email = document.getElementById('email').value.trim();
      if (!email) return alert('Enter your email first.');

      const redirectTo = window.location.origin + '/training2.html';
      setStatus('Sending magic link...');

      const { error } = await supabaseClient.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: redirectTo }
      });

      if (error) {
        console.warn('magic link error:', error.message);
        setStatus('Magic link error.');
        return alert(error.message);
      }

      setStatus('Magic link sent. Check your email.');
      alert('Magic link sent. Check your email and open the link in this browser.');
    }

    async function forgotPassword(){
      const email = document.getElementById('email').value.trim();
      if (!email) return alert('Enter your email first.');

      const redirectTo = window.location.origin + '/training2.html';
      setStatus('Sending reset link...');

      const { error } = await supabaseClient.auth.resetPasswordForEmail(email, { redirectTo });

      if (error) {
        console.warn('reset password error:', error.message);
        setStatus('Reset link error.');
        return alert(error.message);
      }

      setStatus('Reset link sent. Check your email.');
      alert('Password reset link sent. Check your email and open the link in this browser.');
    }


    async function logout(){
      try {
        await supabaseClient.auth.signOut();
      } finally {
        // Clear any recovery state
        sessionStorage.removeItem('pw_recovery_pending');
        // Reset UI and force refresh so it's obvious you're logged out
        await refreshAuthUI();
        setStatus('Logged out. Local-only.');
        // Hard refresh (works reliably even if cached UI state lingers)
        window.location.replace(window.location.pathname + window.location.search);
      }
    }
    
    // ===== Password recovery flow (GitHub Pages) =====
    // Supabase recovery links redirect back with tokens in the URL hash.
    async function handleRecoveryFromUrl(){
      const hash = window.location.hash || "";
      const search = window.location.search || "";

      // If a prior auth-state callback marked recovery pending, show the UI even if the URL hash is bare '#'
      if (sessionStorage.getItem('pw_recovery_pending') === '1') {
        document.getElementById('recoveryBox').style.display = 'block';
        document.getElementById('recoveryStatus').textContent = "Password recovery session detected. Set your new password.";
        return;
      }

      // If the URL contains an error (e.g., otp_expired), show it for clarity.
      if (hash.includes("error=")){
        const params = new URLSearchParams(hash.replace(/^#/, ""));
        const err = params.get("error_description") || params.get("error_code") || params.get("error") || "Unknown error";
        const box = document.getElementById('recoveryBox');
        const status = document.getElementById('recoveryStatus');
        box.style.display = 'block';
        status.textContent = "Recovery link error: " + decodeURIComponent((err || "").replace(/\+/g, " "));
        return;
      }

      // ---- FLOW 1: Implicit hash tokens (#access_token=...&refresh_token=...&type=recovery)
      try {
        if (hash.includes("access_token=") && hash.includes("refresh_token=")){
          const params = new URLSearchParams(hash.replace(/^#/, ""));
          const access_token = params.get("access_token");
          const refresh_token = params.get("refresh_token");
          const type = params.get("type"); // "recovery" for reset-password flows

          if (access_token && refresh_token){
            const { error } = await supabaseClient.auth.setSession({ access_token, refresh_token });
            if (!error){
              if (type === "recovery"){
                sessionStorage.setItem('pw_recovery_pending', '1');
                document.getElementById('recoveryBox').style.display = 'block';
                document.getElementById('recoveryStatus').textContent = "Password recovery session detected. Set your new password below.";
              }
              history.replaceState(null, document.title, window.location.pathname + window.location.search);
              await refreshAuthUI();
              return;
            } else {
              console.warn("setSession error:", error.message);
            }
          }
        }
      } catch (e){
        console.warn("handleRecoveryFromUrl hash flow error:", e);
      }

      // ---- FLOW 2: PKCE code flow (?code=...)
      try {
        const qs = new URLSearchParams(search.replace(/^\?/, ""));
        const code = qs.get("code");
        if (code){
          const { error } = await supabaseClient.auth.exchangeCodeForSession(code);
          if (!error){
            history.replaceState(null, document.title, window.location.pathname);
            await refreshAuthUI();
            return;
          } else {
            console.warn("exchangeCodeForSession error:", error.message);
          }
        }
      } catch (e){
        console.warn("handleRecoveryFromUrl code flow error:", e);
      }
    }

    async function setNewPassword(){
      const p1 = document.getElementById('newPassword').value;
      const p2 = document.getElementById('newPassword2').value;
      const status = document.getElementById('recoveryStatus');

      if (!p1 || p1.length < 8){
        status.textContent = "Password must be at least 8 characters.";
        return;
      }
      if (p1 !== p2){
        status.textContent = "Passwords do not match.";
        return;
      }

      status.textContent = "Setting password...";
      const { error } = await supabaseClient.auth.updateUser({ password: p1 });
      if (error){
        status.textContent = "Failed: " + error.message;
        return;
      }

      status.textContent = "Password updated. You can now log in.";
      // Remove tokens from URL
      history.replaceState(null, document.title, window.location.pathname + window.location.search);
      await refreshAuthUI();
    }


    function collectActualsFromUI(){
      const data = {};
      const inputs = document.querySelectorAll('#trackerForm input, #trackerForm textarea, #trackerForm select');
      inputs.forEach(input => {
        if (input.id === 'Coach_Targets') return;
        if (!input.id) return;
        data[input.id] = (input.type === 'checkbox') ? input.checked : input.value;
      });
      return data;
    }

    function applyActualsToUI(data){
      if (!data) return;
      for (const id in data){
        const el = document.getElementById(id);
        if (!el) continue;
        if (el.type === 'checkbox') el.checked = !!data[id];
        else el.value = data[id];
      }
    }

    function autoSaveLocal(){
      const data = collectActualsFromUI();
      localStorage.setItem(getStorageKey(), JSON.stringify(data));
      setStatus('Saved locally.');
    }

    function scheduleSave(){
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(async () => {
        autoSaveLocal();
        await autoSaveServerBestEffort();
      }, 400);
    }

    async function autoSaveServerBestEffort(){
      if (!currentUser) return;
      if (syncing) return;

      const weekStart = getWeekStart();
      const actuals = collectActualsFromUI();

      const payload = {
        user_id: currentUser.id,
        week_start: weekStart,
        actuals: actuals,
        weekly_summary: document.getElementById('Weekly_Commentary')?.value || null
      };

      const { error } = await supabaseClient
        .from('user_workout_logs')
        .upsert(payload, { onConflict: 'user_id,week_start' });

      if (error) {
        console.warn('upsert user_workout_logs error:', error.message);
        setStatus('Saved locally (sync error).');
      } else {
        setStatus('Saved (synced).');
      }
    }

    function applyTargetsToUI(targets){
      document.querySelectorAll('[data-target]').forEach(el => {
        const key = el.getAttribute('data-target');
        if (targets[key]) el.textContent = targets[key];
      });

      const note = (targets['Coach_Week_Notes'] || '').trim();
      if (note){
        document.getElementById('coachNoteText').textContent = note;
        document.getElementById('coachNote').style.display = 'block';
      } else {
        document.getElementById('coachNoteText').textContent = '';
        document.getElementById('coachNote').style.display = 'none';
      }
    }

    function loadTargetsLocal(){
      const saved = localStorage.getItem(getTargetsKey());
      if (!saved) return false;
      try {
        const targets = JSON.parse(saved);
        applyTargetsToUI(targets);
        document.getElementById('coachBadge').style.display = 'block';
        document.getElementById('coachControls').style.display = 'block';
        document.getElementById('coachBox').classList.add('hidden');
        return true;
      } catch(e) {
        console.warn('Bad targets JSON', e);
        return false;
      }
    }

    async function fetchWeekPlanFromServer(weekStart){
      if (!currentUser) return null;
      const { data, error } = await supabaseClient
        .from('user_week_plans')
        .select('targets, coach_notes')
        .eq('user_id', currentUser.id)
        .eq('week_start', weekStart)
        .maybeSingle();
      if (error) {
        console.warn('fetchWeekPlanFromServer error:', error.message);
        return null;
      }
      return data;
    }

    async function fetchWeekLogFromServer(weekStart){
      if (!currentUser) return null;
      const { data, error } = await supabaseClient
        .from('user_workout_logs')
        .select('actuals, weekly_summary')
        .eq('user_id', currentUser.id)
        .eq('week_start', weekStart)
        .maybeSingle();
      if (error) {
        console.warn('fetchWeekLogFromServer error:', error.message);
        return null;
      }
      return data;
    }

    async function syncFromServerForWeek(){
      if (!currentUser) return;
      const weekStart = getWeekStart();
      if (!weekStart) return;

      syncing = true;
      try {
        const plan = await fetchWeekPlanFromServer(weekStart);
        if (plan?.targets) {
          localStorage.setItem(getTargetsKey(weekStart), JSON.stringify(plan.targets));
          applyTargetsToUI(plan.targets);
          document.getElementById('coachBadge').style.display = 'block';
          document.getElementById('coachControls').style.display = 'block';
          document.getElementById('coachBox').classList.add('hidden');
        }

        const log = await fetchWeekLogFromServer(weekStart);
        if (log?.actuals) {
          localStorage.setItem(getStorageKey(weekStart), JSON.stringify(log.actuals));
          applyActualsToUI(log.actuals);
        }
        if (log?.weekly_summary) {
          const ws = document.getElementById('Weekly_Commentary');
          if (ws) ws.value = log.weekly_summary;
        }
      } finally {
        syncing = false;
      }
    }

    async function upsertWeekPlanToServer(weekStart, targets){
      if (!currentUser) return;

      const payload = {
        user_id: currentUser.id,
        week_start: weekStart,
        program_code: 'run_strength_12wk_v1',
        week_number: 0,
        coach_notes: (targets['Coach_Week_Notes'] || ''),
        targets: targets
      };

      const { error } = await supabaseClient
        .from('user_week_plans')
        .upsert(payload, { onConflict: 'user_id,week_start' });

      if (error) {
        console.warn('upsert user_week_plans error:', error.message);
        setStatus('Targets applied locally (sync error).');
      } else {
        setStatus('Targets applied (synced).');
      }
    }

    function applyCoachTargets(){
      const raw = (document.getElementById('Coach_Targets').value || '').trim();
      if (!raw){ alert('Paste targets first.'); return; }

      const targets = {};
      const lines = raw.split(/\r?\n/);

      let i = 0;
      while (i < lines.length){
        let line = lines[i].trim();
        i++;

        if (!line || line.startsWith('#') || line.startsWith('//')) continue;

        const m = line.match(/^([A-Za-z0-9_]+)\s*:\s*(.*)$/);
        if (!m) continue;

        const key = m[1].trim();
        let val = (m[2] || '').trim();

        if (key === 'Coach_Week_Notes'){
          const noteLines = [val];
          while (i < lines.length){
            const peek = lines[i];
            const peekTrim = peek.trim();
            if (!peekTrim || peekTrim.startsWith('#') || peekTrim.startsWith('//')){
              noteLines.push(peek);
              i += 1;
              continue;
            }
            if (/^[A-Za-z0-9_]+\s*:\s*/.test(peekTrim)) break;
            noteLines.push(peek);
            i += 1;
          }
          val = noteLines.join('\n').trim();
        }

        val = val.replace(/\\n/g, '\n');
        targets[key] = val;
      }

      if (Object.keys(targets).length === 0){ alert('No KEY: VALUE lines found.'); return; }

      localStorage.setItem(getTargetsKey(), JSON.stringify(targets));
      applyTargetsToUI(targets);

      document.getElementById('Coach_Targets').value = '';
      document.getElementById('coachBadge').style.display = 'block';
      document.getElementById('coachControls').style.display = 'block';
      document.getElementById('coachBox').classList.add('hidden');

      setStatus('Targets applied locally.');
      upsertWeekPlanToServer(getWeekStart(), targets);
    }

    function clearTargets(){
      if (!confirm('Clear coach targets for this week?')) return;
      localStorage.removeItem(getTargetsKey());

      document.getElementById('coachBadge').style.display = 'none';
      document.getElementById('coachControls').style.display = 'none';
      document.getElementById('coachNote').style.display = 'none';
      document.getElementById('coachBox').classList.remove('hidden');

      (async () => {
        if (!currentUser) return;
        const weekStart = getWeekStart();
        const { error } = await supabaseClient
          .from('user_week_plans')
          .delete()
          .eq('user_id', currentUser.id)
          .eq('week_start', weekStart);
        if (error) console.warn('delete user_week_plans error:', error.message);
      })();

      location.reload();
    }

    function loadWeekData(){
      const weekStart = getWeekStart();
      const savedData = localStorage.getItem(getStorageKey(weekStart));
      const inputs = document.querySelectorAll('#trackerForm input, #trackerForm textarea, #trackerForm select');

      inputs.forEach(i => {
        if (i.id === 'weekDate' || i.id === 'Coach_Targets') return;
        if (i.type === 'checkbox') i.checked = false;
        else i.value = '';
      });

      const hadTargets = loadTargetsLocal();
      if (!hadTargets){
        document.getElementById('coachBadge').style.display = 'none';
        document.getElementById('coachControls').style.display = 'none';
        document.getElementById('coachNote').style.display = 'none';
        document.getElementById('coachBox').classList.remove('hidden');
      }

      if (savedData){
        try {
          const data = JSON.parse(savedData);
          applyActualsToUI(data);
        } catch(e) {
          console.warn('Bad local actuals JSON', e);
        }
      }

      if (currentUser) {
        syncFromServerForWeek().then(() => setStatus('Loaded (synced).'));
      } else {
        setStatus('Loaded (local).');
      }
    }

    function clearWeek(){
      if (!confirm('Clear this week?')) return;
      localStorage.removeItem(getStorageKey());
      loadWeekData();
      setStatus('Cleared week (targets kept).');

      (async () => {
        if (!currentUser) return;
        const weekStart = getWeekStart();
        const { error } = await supabaseClient
          .from('user_workout_logs')
          .delete()
          .eq('user_id', currentUser.id)
          .eq('week_start', weekStart);
        if (error) console.warn('delete user_workout_logs error:', error.message);
      })();
    }

    async function shareData(){
      const week = getWeekStart();
      let summary = `Workout Summary: ${week}\n\n`;

      summary += `TARGETS (as displayed in UI)\n`;
      const targets = {};
      document.querySelectorAll('[data-target]').forEach(el => {
        const key = el.getAttribute('data-target');
        const val = (el.textContent || '').trim();
        if (key && val) targets[key] = val;
      });
      Object.keys(targets).sort().forEach(k => {
        summary += `${k}: ${targets[k]}\n`;
      });

      summary += `\nACTUALS\n(Assumed completed as prescribed unless Actuals/Notes say otherwise)\n`;

      const inputs = document.querySelectorAll('#trackerForm input, #trackerForm textarea, #trackerForm select');
      inputs.forEach(input => {
        if (input.id === 'Coach_Targets') return;
        const val = input.type === 'checkbox' ? (input.checked ? 'DONE' : '') : input.value;
        const name = input.getAttribute('data-name') || input.id;
        if (val && val !== '') summary += `\n${name}: ${val}`;
      });

      await navigator.clipboard.writeText(summary);
      alert('Summary copied to clipboard!');
    }

    async function initApp(){
      const d = new Date();
      const day = d.getDay(), diff = d.getDate() - day + (day === 0 ? -6 : 1);
      const monday = new Date(d.setDate(diff)).toISOString().split('T')[0];
      document.getElementById('weekDate').value = monday;

      document.getElementById('loginBtn').addEventListener('click', login);
      document.getElementById('logoutBtn').addEventListener('click', logout);

      
      document.getElementById('setPasswordBtn').addEventListener('click', setNewPassword);

      document.getElementById('magicLinkBtn').addEventListener('click', sendMagicLink);
      document.getElementById('forgotPwBtn').addEventListener('click', forgotPassword);
supabaseClient.auth.onAuthStateChange(async (event, session) => {
        // event can be: SIGNED_IN, SIGNED_OUT, PASSWORD_RECOVERY, TOKEN_REFRESHED, USER_UPDATED, etc.
        await refreshAuthUI();

        if (event === 'PASSWORD_RECOVERY') {
          // Some clients arrive with a bare '#', but Supabase still sets a session.
          sessionStorage.setItem('pw_recovery_pending', '1');
          document.getElementById('recoveryBox').style.display = 'block';
          document.getElementById('recoveryStatus').textContent = "Password recovery session detected. Set your new password below.";
        }

        if (event === 'SIGNED_OUT') {
          sessionStorage.removeItem('pw_recovery_pending');
          const rb = document.getElementById('recoveryBox');
          if (rb) rb.style.display = 'none';
        }

        if (event === 'USER_UPDATED') {
          // Often fired after password update; clear recovery state
          sessionStorage.removeItem('pw_recovery_pending');
          const rb = document.getElementById('recoveryBox');
          if (rb) rb.style.display = 'none';
        }

        if (currentUser) await syncFromServerForWeek();
      });
await refreshAuthUI();

      await handleRecoveryFromUrl();

      loadWeekData();
      loadTargetsLocal();
      if (currentUser) await syncFromServerForWeek();

      document.getElementById('trackerForm').addEventListener('input', scheduleSave);
      document.getElementById('weekDate').addEventListener('change', () => {
        loadWeekData();
      });
    }
  </script>

</body>
</html>